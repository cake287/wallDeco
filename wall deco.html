<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
</head>
<body>
<script>
const numLines = 40;
const kMax = numLines / 4;

function setup() {
  createCanvas(800, 800);
  background(255);
}


function getLinePoints(i, radius=100, lineLength=1000) {
  const angle = (TWO_PI / numLines) * i;

  let x = radius * cos(angle);
  let y = radius * sin(angle);

  let tangentAngle = angle + PI / 2; // Perpendicular to radius

  let x1 = x + lineLength * cos(tangentAngle);
  let y1 = y + lineLength * sin(tangentAngle);
  let x2 = x - lineLength * cos(tangentAngle);
  let y2 = y - lineLength * sin(tangentAngle);

  return {x1, y1, x2, y2};
}

function getLine(i) {
  // get equation of the line in the form Ax + By + C = 0
  let {x1, y1, x2, y2} = getLinePoints(i);
  let A = y2 - y1;
  let B = x1 - x2;
  let C = x2 * y1 - x1 * y2;
  return {A, B, C};
}

function getIntersection(line1, line2) {
  let {A: A1, B: B1, C: C1} = line1;
  let {A: A2, B: B2, C: C2} = line2;

  let det = A1 * B2 - A2 * B1;
  if (det === 0) {
    return null; // Lines are parallel
  } else {
    let x = (B2 * (-C1) - B1 * (-C2)) / det;
    let y = (A1 * (-C2) - A2 * (-C1)) / det;
    return {x, y};
  }
}

function getShape(i, k) {
  // if i is whole number
  if (Number.isInteger(i)) {
    let p1 = getIntersection(getLine(i - k), getLine(i + k));
    let p2 = getIntersection(getLine(i - k - 1), getLine(i + k));
    let p3 = getIntersection(getLine(i - k - 1), getLine(i + k + 1));
    let p4 = getIntersection(getLine(i - k), getLine(i + k + 1));
    return p1 ? [p1, p2, p3, p4] : [p2, p3, p4];
  } else {
    let p1 = getIntersection(getLine(i - k - 0.5), getLine(i + k + 0.5));
    let p2 = getIntersection(getLine(i - k - 1.5), getLine(i + k + 0.5));
    let p3 = getIntersection(getLine(i - k - 1.5), getLine(i + k + 1.5));
    let p4 = getIntersection(getLine(i - k - 0.5), getLine(i + k + 1.5));
    return [p1, p2, p3, p4];
  }
}

function drawShape(points, insetProportion=0) {
  const centroid = points.reduce((acc, p) => ({x: acc.x + p.x / points.length, y: acc.y + p.y / points.length}), {x:0, y:0});
  if (insetProportion > 0) {
    points = points.map(p => {
      let angle = atan2(p.y - centroid.y, p.x - centroid.x);
      return {
        x: centroid.x + (1 - insetProportion) * (p.x - centroid.x),
        y: centroid.y + (1 - insetProportion) * (p.y - centroid.y)
      };
    });
  }

  if (points.length == 3) {
    triangle(points[0].x, points[0].y, points[1].x, points[1].y, points[2].x, points[2].y);
  } else if (points.length == 4) {
    quad(points[0].x, points[0].y, points[1].x, points[1].y, points[2].x, points[2].y, points[3].x, points[3].y);
  }
}

function shade(colID) {
  switch (colID) {
    case 0:
    case true:
      fill(0, 0, 128, 255);
      break;
    // case 1:
    //   fill(0, 128, 255, 255);
    //   break;
    default:
      fill(0, 80, 180, 255);
      break;
  }
}

function shadeGradient(col1, col2, factor, steps=undefined) {
  if (steps) {
    factor = Math.floor(factor * steps) / (steps - 1);
  }

  let r = lerp(col1[0], col2[0], factor);
  let g = lerp(col1[1], col2[1], factor);
  let b = lerp(col1[2], col2[2], factor);
  let a = lerp(col1[3], col2[3], factor);
  fill(r, g, b, a);
}


let t = 0;

function draw() {
  background(255);
  // translate(width * 0.65, height * 0.45);
  translate(width * 0.5, height * 0.5);

  for (let i = 0; i < numLines; i++) {
    // draw tangent line
    let {x1, y1, x2, y2} = getLinePoints(i);
    stroke(0, 100);
    // line(x1, y1, x2, y2);

    for (let k = 0; k < kMax; k++) {
      for (let di = 0; di <= 1; di++) {
        const i2 = i + di/2;

        // SPIRAL BAD
        // let col = i2 + 10*k;
        // col = col % (numLines + kMax);
        // fill(0, 0, map(col, 0, numLines + kMax, 250, 30), 255);

        
        // if (i2*2 == (Math.floor(0.05*t) % (2*numLines))) {
        //   shade(0);
        // } else
        // {
        //   shadeGradient([0, 148, 255, 255], [0, 255, 144, 255], 1 - k / kMax);
        // }

        const angle = (TWO_PI / numLines) * i2;
        shadeGradient(
          // [0, 148, 255, 255],
          // [0, 200, 200, 255],
          [195, 204, 199, 255],
          [16, 97, 153, 255],
          // 0.5 + 0.5 * sin(2*(1+cos(0.025*t))*angle + k * 0.6 + t * 0.03)
          0.5 + 0.5 * sin(angle + k * 0.6 )//+ t * 0.03)
          
        );



        noStroke();
        const points = getShape(i2, k);
        drawShape(points, 0.06);
      }
    }
  }

  t++;
}
</script>
</body>
</html>